import scrapy
import json
from ..items import BagRankingCrawlerItem
import re

class ProductSpider(scrapy.Spider):
    name = "sothebys"

    def make_request(self, page):
        url = 'https://kar1ueupjd-1.algolianet.com/1/indexes/prod_lots/query?x-algolia-agent=Algolia%20for%20JavaScript%20(4.14.3)%3B%20Browser'
        headers = {
            "accept": "application/json, text/plain, */*",
            "content-type": "application/json",
            "sec-ch-ua": "\"Microsoft Edge\";v=\"111\", \"Not(A:Brand\";v=\"8\", \"Chromium\";v=\"111\"",
            "sec-ch-ua-mobile": "?0",
            "sec-ch-ua-platform": "\"Windows\"",
            "x-algolia-api-key": "YmQwZmVmMjcxMjM3NzZlOTY4OGNmMDAwMGYxZWRkOTAwM2MxMjNjZDZlZjQ2NTU5MzE4NmYyMGQxNWI4ZTI1NnZhbGlkVW50aWw9MTY4MTIzMTk1OCZyZXN0cmljdEluZGljZXM9YXVjdGlvbnMlMkNwcm9kX2F1Y3Rpb25zJTJDcHJvZF9hdWN0aW9uc18qJTJDcHJvZF9hdWN0aW9uc19uYW1lX2FzYyUyQ3Byb2RfYXVjdGlvbnNfbmFtZV9kZXNjJTJDcHJvZF9hdWN0aW9uc19zdGFydERhdGVfYXNjJTJDcHJvZF9hdWN0aW9uc19zdGFydERhdGVfZGVzYyUyQ3Byb2RfYXVjdGlvbnNfZW5kRGF0ZV9hc2MlMkNwcm9kX2F1Y3Rpb25zX2VuZERhdGVfZGVzYyUyQ3Byb2RfYXVjdGlvbnNfY2xvc2VEYXRlX2FzYyUyQ3Byb2RfYXVjdGlvbnNfY2xvc2VEYXRlX2Rlc2MlMkNjcmVhdG9ycyUyQ3Byb2RfY3JlYXRvcnMlMkNwcm9kX2NyZWF0b3JzXyolMkNjcmVhdG9yc1YyJTJDcHJvZF9jcmVhdG9yc1YyJTJDcHJvZF9jcmVhdG9yc1YyXyolMkNsb3RzJTJDcHJvZF9sb3RzJTJDcHJvZF9sb3RzXyolMkNwcm9kX2xvdHNfbG90TnJfYXNjJTJDcHJvZF9sb3RzX2xvdE5yX2Rlc2MlMkNwcm9kX2xvdHNfYXVjdGlvbkRhdGVfYXNjJTJDcHJvZF9sb3RzX2F1Y3Rpb25EYXRlX2Rlc2MlMkNwcm9kX3VwY29taW5nX2xvdHNfYXNjJTJDcHJvZF91cGNvbWluZ19sb3RzX2Rlc2MlMkNwcm9kX2xvdHNfbG93RXN0aW1hdGVfYXNjJTJDcHJvZF9sb3RzX2xvd0VzdGltYXRlX2Rlc2MlMkNwcm9kX3N1Z2dlc3RlZF9sb3RzJTJDcHJvZF9meWVvX2xvdHNfYXVjdGlvbkRhdGVfYXNjJTJDcHJvZF9meWVvX2xvdHNfYXVjdGlvbkRhdGVfZGVzYyUyQ29iamVjdF90eXBlcyUyQ3Byb2Rfb2JqZWN0X3R5cGVzJTJDcHJvZF9vYmplY3RfdHlwZXNfKiUyQ2l0ZW1zJTJDcHJvZF9pdGVtcyUyQ3Byb2RfaXRlbXNfKiUyQ2F0dHJpYnV0ZXMlMkNwcm9kX2F0dHJpYnV0ZXMlMkNwcm9kX2F0dHJpYnV0ZXNfKiUyQ2F0dHJpYnV0ZV9maXhlZF92YWx1ZXMlMkNwcm9kX2F0dHJpYnV0ZV9maXhlZF92YWx1ZXMlMkNwcm9kX2F0dHJpYnV0ZV9maXhlZF92YWx1ZXNfKiUyQ3BpZWNlcyUyQ3Byb2RfcGllY2VzJTJDcHJvZF9waWVjZXNfKiUyQ3Byb2R1Y3RfaXRlbXMlMkNwcm9kX3Byb2R1Y3RfaXRlbXMlMkNwcm9kX3Byb2R1Y3RfaXRlbXNfKiUyQ3Byb2RfcHJvZHVjdF9pdGVtc19sb3dFc3RpbWF0ZV9hc2MlMkNwcm9kX3Byb2R1Y3RfaXRlbXNfbG93RXN0aW1hdGVfZGVzYyUyQ3Byb2RfcHJvZHVjdF9pdGVtc19wdWJsaXNoRGF0ZV9hc2MlMkNwcm9kX3Byb2R1Y3RfaXRlbXNfcHVibGlzaERhdGVfZGVzYyUyQ3NvdGhlYnlzX2NhdGVnb3JpZXMlMkNzb3RoZWJ5c19jYXRlZ29yaWVzJTJDc290aGVieXNfY2F0ZWdvcmllc18qJTJDdGFnZ2luZ190YWdzZXRzJTJDcHJvZF90YWdnaW5nX3RhZ3NldHMlMkNwcm9kX3RhZ2dpbmdfdGFnc2V0c18qJTJDdGFnZ2luZ190YWdzJTJDcHJvZF90YWdnaW5nX3RhZ3MlMkNwcm9kX3RhZ2dpbmdfdGFnc18qJTJDb25ib2FyZGluZ190b3BpY3MlMkNwcm9kX29uYm9hcmRpbmdfdG9waWNzJTJDcHJvZF9vbmJvYXJkaW5nX3RvcGljc18qJTJDZm9sbG93YWJsZV90b3BpY3MlMkNwcm9kX2ZvbGxvd2FibGVfdG9waWNzJTJDcHJvZF9mb2xsb3dhYmxlX3RvcGljc18qJTJDd2luZSUyQ3Byb2Rfd2luZSUyQ3Byb2Rfd2luZV8qJmZpbHRlcnM9Tk9UK3N0YXRlJTNBQ3JlYXRlZCtBTkQrTk9UK3N0YXRlJTNBRHJhZnQrQU5EK05PVCtpc1Rlc3RSZWNvcmQlM0QxK0FORCslMjhOT1QrbG9jYXRpb24lM0ElMjJTaGFuZ2hhaStBdWN0aW9uJTIyJTI5K0FORCtOT1QrbG90U3RhdGUlM0FDcmVhdGVkK0FORCtOT1QrbG90U3RhdGUlM0FEcmFmdCtBTkQrJTI4Tk9UK2lzSGlkZGVuJTNBdHJ1ZStPUitsZWFkZXJJZCUzQThlYjY1ZDllLWQ4ZmItNDhhOS1hZjI0LTIxNWYzMzE1YWNkZCUyOQ==",
            "x-algolia-application-id": "KAR1UEUPJD"
        }
        body = {"query": "", "filters": "auctionId:d5e57dfe-2eb9-4a79-8694-c9d0aa65750a AND objectTypes:\"All\" AND NOT isHidden:true",
                "facetFilters": [["withdrawn:false"], []], "hitsPerPage": 48, "page": page, "facets": ["*"], "numericFilters": []}
        return scrapy.Request(url, method="POST", headers=headers, body=json.dumps(body), callback=self.parse)

    def start_requests(self):
        yield self.make_request(1)

    def parse(self, response):
        data = json.loads(response.body)
        items = data['hits']
        for item in items:
            new_item = BagRankingCrawlerItem()
            new_item['title'] = item['title']
            new_item['link'] = 'https://www.sothebys.com'+item['slug']
            new_item['brand'] = item['creators'][0]
            objectID = item['objectID']
            url = 'https://clientapi.prod.sothelabs.com/graphql'
            headers = {
                "accept": "application/json, text/plain, */*",
                "content-type": "application/json",
                "sec-ch-ua": "\"Microsoft Edge\";v=\"111\", \"Not(A:Brand\";v=\"8\", \"Chromium\";v=\"111\"",
                "sec-ch-ua-mobile": "?0",
                "sec-ch-ua-platform": "\"Windows\"",
                "authorization": "Bearer eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6Ik5ETkdNakZEUmpRelJFRTJNalpFUWpVeU56TTRNalExUWprM05ESkNOemcwTXpkRE1VSXpOQSJ9.eyJodHRwOi8vc2NoZW1hcy5zb3RoZWJ5cy5jb20vYXBwX21ldGFkYXRhIjp7ImNvbnNlbnQiOnsiY29uc2VudE9uU2lnbnVwIjp0cnVlLCJsYXRlc3RDb25zZW50IjoiRnJpLCAxNyBNYXIgMjAyMyAwNjo1NjoxNSBHTVQifSwiY3VzdG9tZXJEYXRhIjp7ImNsaWVudEluZm9JZCI6IjJkYzQyY2IxLTdmZTgtNDZmMi05MzRhLWRmYWZkNzBmOGUwYiIsInBhcnR5SWQiOjAsInByZWZlcnJlZCI6ZmFsc2UsInVzZXJJZCI6IjhlYjY1ZDllLWQ4ZmItNDhhOS1hZjI0LTIxNWYzMzE1YWNkZCJ9fSwiaHR0cDovL3NjaGVtYXMuc290aGVieXMuY29tL3VzZXJNZXRhZGF0YSI6eyJmaXJzdE5hbWUiOiJ0aGluaCIsImxhc3ROYW1lIjoibmdvIiwibmFtZSI6InRoaW5oIG5nbyIsIm5vRW1haWxzIjpmYWxzZSwib3B0ZWRPdXQiOnRydWUsInRpdGxlIjoiTXMifSwiaXNzIjoiaHR0cHM6Ly9hY2NvdW50cy5zb3RoZWJ5cy5jb20vIiwic3ViIjoiYXV0aDB8NjQxNDBmMTAwMzkxODhmNDk0NGI5NzIwIiwiYXVkIjpbImh0dHBzOi8vY3VzdG9tZXIuYXBpLnNvdGhlYnlzLmNvbSIsImh0dHBzOi8vc290aGVieXMuYXV0aDAuY29tL3VzZXJpbmZvIl0sImlhdCI6MTY4MTIxOTY2MSwiZXhwIjoxNjgxMzA2MDYxLCJhenAiOiJMdm1WblVnMWw1dEQ1eDQwS3lkektKQU9CVFhqRVNQbiIsInNjb3BlIjoib3BlbmlkIGVtYWlsIn0.DfnDbywGdIAcI0QJstWlD0zokDJHozGGI-znWGL52FYiXYpVZjPnnfO3N3igdTpNFUzvjbni6Na4ZVw9EgRnhE2aHxgVSBFduSwJ3qN2R9A22XkVCWxnf1Nl7aHjW4xc7iEstgbKNEw81SA8myuOUUGa8ZFZJVzlgfkC6idydzty-bFjPtiR-1c0izUmVoFX9GQ7lQc7hlm7mfDQWT3UoZG_sa6YttF5hACFXLSm5SgPEFQdhAaogirk_cKMba-ZFIY5UiQz77pTO7uIBB--k-mlwqdMlidW6t5sgZ_ZNx43TUlcqtEcZgIFnFXApMy1AzZsHoimJWox6ZSm10uC0Q"
            }
            body= {"operationName":"LotQuery","variables":{"id":objectID},"query":"query LotQuery($id: String!) {\n  lot: lotV2(lotId: $id) {\n    __typename\n    ... on LotV2 {\n      __typename\n      auction {\n        ...UploadIdFragment\n        __typename\n      }\n      ...LotV2Fragment\n      ...LotDetailNavHeaderFragment\n      ...PlaceBidTombstoneMenuFragment\n      ...PlaceBidTombstoneFragment\n      ...LotDetailCarouselFragment\n      ...LotInfoFragment\n      ...LotDetailCatalogueBSPFragment\n      ...RecommendedItemsFragment\n      ...RecommendedWatchesFragment\n      ...StickyHeaderContentFragment\n      ...PageWrapperLotFragment\n    }\n    ... on HiddenLot {\n      __typename\n      lotId\n      auction {\n        __typename\n        title\n        auctionId\n        slug {\n          __typename\n          year\n          name\n        }\n      }\n    }\n  }\n}\n\nfragment LotDetailCarouselFragment on LotV2 {\n  __typename\n  auction {\n    __typename\n    sapSaleNumber\n    departmentNames\n  }\n  lotId\n  title\n  lotNumber {\n    __typename\n    ... on VisibleLotNumber {\n      __typename\n      lotNumber\n    }\n  }\n  media(imageSizes: [Small, Medium, Large, ExtraLarge, Original]) {\n    __typename\n    images {\n      __typename\n      title\n      renditions {\n        __typename\n        url\n        width\n        height\n        imageSize\n      }\n    }\n  }\n}\n\nfragment LotDetailCatalogueBSPFragment on LotV2 {\n  __typename\n  lotId\n  auction {\n    __typename\n    enrichedCatalogueContentEnabled\n  }\n}\n\nfragment LotDetailNavHeaderFragment on LotV2 {\n  __typename\n  title\n  lotNumber {\n    __typename\n    ... on VisibleLotNumber {\n      __typename\n      lotNumber\n    }\n  }\n  auction {\n    __typename\n    title\n    auctionId\n    slug {\n      __typename\n      year\n      name\n    }\n  }\n  ...LotNavigationArrowsFragment\n  ...LotNavigationDropdownFragment\n}\n\nfragment LotNavigationArrowsFragment on LotV2 {\n  __typename\n  id\n  auction {\n    __typename\n    auctionId\n    slug {\n      __typename\n      year\n      name\n    }\n  }\n  previousLot {\n    __typename\n    slug\n    lotId\n  }\n  nextLot {\n    __typename\n    slug\n    lotId\n  }\n}\n\nfragment LotNavigationDropdownFragment on LotV2 {\n  __typename\n  lotId\n  lotNumber {\n    __typename\n    ... on VisibleLotNumber {\n      __typename\n      lotNumber\n    }\n  }\n  auction {\n    __typename\n    auctionId\n    useCreatorSplit\n    lotCards(filter: ALL) {\n      __typename\n      lotId\n      lotNumber {\n        __typename\n        ... on VisibleLotNumber {\n          __typename\n          lotNumber\n        }\n      }\n      creators {\n        __typename\n        displayName\n      }\n      creatorPrefix\n      slug {\n        __typename\n        lotSlug\n        auctionSlug {\n          __typename\n          year\n          name\n        }\n      }\n      title\n      subtitle\n    }\n  }\n}\n\nfragment LotInfoFragment on LotV2 {\n  __typename\n  auction {\n    __typename\n    sapSaleNumber\n    departmentNames\n    useCreatorSplit\n    showGuaranteeLine\n  }\n  lotId\n  description\n  saleroomNotice\n  condition {\n    __typename\n    ... on ConditionHidden {\n      __typename\n      contactEmail\n    }\n    ... on ConditionPublished {\n      __typename\n      disclaimer\n      report\n      conditionReportDisclaimers {\n        __typename\n        content\n      }\n    }\n  }\n  conditionReportDisclaimers {\n    __typename\n    content\n  }\n  generalLotNotices {\n    __typename\n    content\n  }\n  catalogueNote\n  title\n  creatorPrefix\n  creators {\n    __typename\n    id\n    displayName\n  }\n  objects {\n    __typename\n    literature\n    exhibition\n    provenance\n  }\n  lotNumber {\n    __typename\n    ... on VisibleLotNumber {\n      __typename\n      lotNumber\n    }\n  }\n}\n\nfragment LotV2Fragment on LotV2 {\n  __typename\n  auction {\n    __typename\n    auctionId\n    title\n    currency\n    location\n    departmentNames\n    type_: type\n    slug {\n      __typename\n      name\n      year\n    }\n    sessions {\n      __typename\n      id\n      sessionId\n      title\n      state: stateV2 {\n        ...SessionStateCommonFragment\n        __typename\n      }\n    }\n    recommendedLotsEnabled\n    bidIncrementTable {\n      __typename\n      id\n      bidIncrements {\n        __typename\n        from\n        increment\n      }\n    }\n    state\n    sapSaleNumber\n    bidPhase {\n      __typename\n      auctionBidPhase {\n        __typename\n        ... on TimedAuctionBidPhaseType {\n          __typename\n          timedBidPhase\n        }\n        ... on LiveAuctionBidPhaseType {\n          __typename\n          bidMethod\n        }\n      }\n    }\n    enrollment {\n      __typename\n      restrictedDate\n      result {\n        ...AuctionBaseEnrollmentResultFragment\n        __typename\n      }\n    }\n    conditionsOfSale\n    bidTypeAvailability {\n      __typename\n      online {\n        __typename\n        isAvailable\n      }\n      saleroom {\n        __typename\n        isAvailable\n      }\n      phone {\n        __typename\n        isAvailable\n        availabilityStatus {\n          __typename\n          ... on DisabledAvailabilityStatus {\n            __typename\n            auctionId\n          }\n          ... on EnabledAvailabilityStatus {\n            __typename\n            auctionId\n          }\n          ... on ScheduledAvailabilityStatus {\n            __typename\n            auctionId\n            cutoffTime\n          }\n        }\n      }\n    }\n    dates {\n      __typename\n      acceptsBids\n    }\n    ...GoToAuctionRoomFragment\n    ...PendingFragment\n  }\n  title\n  lotId\n  slug\n  lotNumber {\n    __typename\n    ... on VisibleLotNumber {\n      __typename\n      lotNumber\n    }\n  }\n  estimateV2 {\n    __typename\n    ... on LowHighEstimateV2 {\n      __typename\n    }\n  }\n  session {\n    __typename\n    sessionId\n    stateV2 {\n      __typename\n      state\n    }\n  }\n  bidState {\n    __typename\n    bidTypeV2 {\n      __typename\n      ... on TimedBidTypeV2 {\n        __typename\n        timedBidPhase\n      }\n      ... on LiveBidType {\n        __typename\n        liveBidPhase\n      }\n    }\n  }\n  brightcoveVideoId\n}\n\nfragment AuctionBaseEnrollmentResultFragment on EnrollmentResultConnection {\n  __typename\n  id\n  auctionId\n  enrollmentResult {\n    __typename\n    ... on EnrollmentAccepted {\n      __typename\n      auctionId\n      paddleId\n    }\n    ... on EnrollmentDeclined {\n      __typename\n      auctionId\n      enrollmentDeclinedReason\n    }\n    ... on EnrollmentUpForReview {\n      __typename\n      auctionId\n      enrollmentUpForReviewReason\n    }\n  }\n}\n\nfragment GoToAuctionRoomFragment on Auction {\n  __typename\n  title\n  sessions {\n    __typename\n    id\n    sessionId\n    title\n    state: stateV2 {\n      ...SessionStateCommonFragment\n      __typename\n    }\n  }\n}\n\nfragment SessionStateCommonFragment on SessionState {\n  __typename\n  id\n  state\n}\n\nfragment PendingFragment on Auction {\n  __typename\n  title\n  locationV2 {\n    __typename\n    displayLocation {\n      __typename\n      name\n    }\n  }\n}\n\nfragment PageWrapperLotFragment on LotV2 {\n  __typename\n  lotId\n  title\n  media(imageSizes: [Small, Medium, Large, ExtraLarge, Original]) {\n    __typename\n    images {\n      __typename\n      renditions {\n        __typename\n        height\n        imageSize\n        url\n        width\n      }\n      title\n    }\n  }\n  bidState {\n    __typename\n    sold {\n      __typename\n      ... on ResultVisible {\n        __typename\n        isSold\n      }\n    }\n  }\n  description\n  condition {\n    __typename\n    ... on ConditionPublished {\n      __typename\n      report\n    }\n    ... on ConditionHidden {\n      __typename\n    }\n  }\n  auction {\n    __typename\n    auctionId\n    title\n    slug {\n      __typename\n      year\n    }\n    departmentNames\n    testRecord\n  }\n}\n\nfragment PlaceBidTombstoneFragment on LotV2 {\n  __typename\n  ...TitleFragment\n  ...LotSymbolsAndTagsFragment\n  ...PlaceBidTombstoneMenuFragment\n  ...TombstoneBidFlow_lot\n}\n\nfragment LotSymbolsAndTagsFragment on LotV2 {\n  __typename\n  symbols\n  lotTags\n  parcel {\n    __typename\n    parcelName\n  }\n  acceptsCryptoPayments\n  premiumLotState {\n    __typename\n    isPremium\n  }\n}\n\nfragment PlaceBidTombstoneMenuFragment on LotV2 {\n  __typename\n  lotId\n  sapAuctionSaleNumber\n  lotNumber {\n    __typename\n    ... on VisibleLotNumber {\n      __typename\n      lotNumber\n    }\n  }\n  slug\n  creatorPrefix\n  creators {\n    __typename\n    id\n    displayName\n  }\n  bidState {\n    __typename\n    isClosed\n  }\n  auction {\n    __typename\n    currency\n    costEstimationEnabled\n    useCreatorSplit\n    slug {\n      __typename\n      name\n      year\n    }\n    type_: type\n  }\n  ...LotSaveHeartFragment\n  ...CostEstimatorFragment\n  ...TombstoneCountdown_lotTimer\n}\n\nfragment CostEstimatorFragment on LotV2 {\n  __typename\n  auction {\n    __typename\n    location\n    currency\n    sapSaleNumber\n    bidIncrementTable {\n      __typename\n      bidIncrements {\n        __typename\n        from\n        increment\n      }\n    }\n  }\n  description\n  lotId\n  title\n  subtitle\n  lotNumber {\n    __typename\n    ... on VisibleLotNumber {\n      __typename\n      lotNumber\n    }\n  }\n  estimate {\n    __typename\n    ... on LowHighEstimate {\n      __typename\n      lowEstimate\n      highEstimate\n    }\n    ... on EstimateUponRequest {\n      __typename\n    }\n  }\n}\n\nfragment LotSaveHeartFragment on LotV2 {\n  __typename\n  isSaved\n  lotId\n  session {\n    __typename\n    sessionId\n  }\n  lotNumber {\n    __typename\n    ... on VisibleLotNumber {\n      __typename\n      lotNumber\n    }\n  }\n  auction {\n    __typename\n    sapSaleNumber\n    type_: type\n  }\n}\n\nfragment TombstoneCountdown_lotTimer on LotV2 {\n  __typename\n  auction {\n    __typename\n    sessions {\n      __typename\n      sessionId\n    }\n    dates {\n      __typename\n      __typename\n      closed\n    }\n    bidPhase {\n      ...AuctionBidPhaseFragment\n      __typename\n    }\n  }\n  session {\n    __typename\n    scheduledOpeningDate\n    stateV2 {\n      ...SessionStateCommonFragment\n      __typename\n    }\n  }\n  bidState {\n    ...TombstoneCountdown_bidState\n    __typename\n  }\n}\n\nfragment AuctionBidPhaseFragment on AuctionBidPhaseConnection {\n  __typename\n  id\n  auctionBidPhase {\n    __typename\n    ... on TimedAuctionBidPhaseType {\n      __typename\n      closingInterval\n      timedBidPhase\n    }\n    ... on LiveAuctionBidPhaseType {\n      __typename\n      bidMethod\n      liveBidPhase\n    }\n  }\n}\n\nfragment TombstoneCountdown_bidState on BidState {\n  __typename\n  id\n  ...TombstoneCountdown_timedBidState\n  bidType: bidTypeV2 {\n    __typename\n    ... on LiveBidType {\n      ...TombstoneCountdown_liveBidType\n      __typename\n    }\n    ... on TimedBidTypeV2 {\n      ...TombstoneCountdown_timedBidType\n      __typename\n    }\n  }\n}\n\nfragment TombstoneCountdown_liveBidType on LiveBidType {\n  __typename\n  liveBidPhase\n}\n\nfragment TombstoneCountdown_timedBidState on BidState {\n  __typename\n  closingTime\n}\n\nfragment TombstoneCountdown_timedBidType on TimedBidTypeV2 {\n  __typename\n  timedBidPhase\n}\n\nfragment TitleFragment on LotV2 {\n  __typename\n  auction {\n    __typename\n    useCreatorSplit\n  }\n  designationLine\n  creatorPrefix\n  title\n  subtitle\n  creators {\n    __typename\n    displayName\n  }\n}\n\nfragment TombstoneBidFlow_lot on LotV2 {\n  __typename\n  lotId\n  title\n  lotNumber {\n    __typename\n    ... on VisibleLotNumber {\n      __typename\n      lotNumber\n    }\n  }\n  session {\n    __typename\n    sessionId\n  }\n  auction {\n    __typename\n    auctionId\n    sapSaleNumber\n    title\n    enrollment {\n      __typename\n      paddle\n      account {\n        __typename\n        holderName\n        accountId\n      }\n      restrictedDate\n      result {\n        ...AuctionBaseEnrollmentResultFragment\n        __typename\n      }\n    }\n    currencyV2\n    departmentNames\n    bidPhase {\n      __typename\n      auctionBidPhase {\n        __typename\n        ... on LiveAuctionBidPhaseType {\n          __typename\n        }\n        ... on TimedAuctionBidPhaseType {\n          __typename\n        }\n      }\n    }\n    bidTypeAvailability {\n      __typename\n      advance {\n        __typename\n        availabilityStatus {\n          __typename\n          ... on DisabledAvailabilityStatus {\n            __typename\n            auctionId\n          }\n        }\n      }\n    }\n    _type: type\n    locationV2 {\n      __typename\n      name\n    }\n  }\n  withdrawnState {\n    ...TombstoneBidFlow_WithdrawnLotState\n    __typename\n  }\n  ...TombstoneBidFlow_bidCapCheck\n  latestBid {\n    ...TombstoneBidFlow_UserBidConnection\n    __typename\n  }\n  ...TombstoneBidFlow_ActionButton\n  ...TombstoneCountdown_lotTimer\n  ...TombstoneBiddingInfo_BiddingInfo\n  ...UserBidInfoFragment\n  ...TombstoneEnterBidFragment\n  ...TombstoneSelectAccountFragment\n  ...TombstoneBidDetailsFragment\n}\n\nfragment TombstoneBidDetailsFragment on LotV2 {\n  __typename\n  ...TombstoneBidDetails_BidInfo\n  ...TombstoneBidDetails_BidPlaced\n}\n\nfragment TombstoneBidDetails_BidInfo on LotV2 {\n  __typename\n  auction {\n    __typename\n    bidIncrementTable {\n      __typename\n      hasBuyersPremium\n    }\n    currencyV2\n  }\n}\n\nfragment TombstoneBidDetails_BidPlaced on LotV2 {\n  __typename\n  auction {\n    __typename\n    auctionId\n    sapSaleNumber\n    departmentNames\n    type_: type\n    locationV2 {\n      __typename\n      name\n    }\n    currencyV2\n  }\n  bidState {\n    ...TombstoneBidDetails_BidState\n    __typename\n  }\n}\n\nfragment TombstoneBidDetails_BidState on BidState {\n  __typename\n  currentBid: currentBidV2 {\n    __typename\n    amount\n  }\n}\n\nfragment TombstoneBidFlow_ActionButton on LotV2 {\n  __typename\n  auction {\n    __typename\n    sapSaleNumber\n    auctionId\n    title\n  }\n  lotId\n  title\n  lotNumber {\n    __typename\n    ... on VisibleLotNumber {\n      __typename\n      lotNumber\n    }\n  }\n  bidState {\n    ...TombstoneBidFlow_bidState\n    __typename\n  }\n  premiumLotState {\n    ...TombstoneBidFlow_PremiumLotState\n    __typename\n  }\n  ...TombstoneBidFlow_PlaceBid\n  ...TombstoneBidFlow_RegisterToBid\n}\n\nfragment TombstoneBidFlow_PlaceBid on LotV2 {\n  __typename\n  id\n  auction {\n    __typename\n    sapSaleNumber\n    auctionId\n    title\n    slug {\n      __typename\n      name\n      year\n    }\n    enrollment {\n      __typename\n      restrictedDate\n      result {\n        ...AuctionBaseEnrollmentResultFragment\n        __typename\n      }\n    }\n  }\n  title\n  lotNumber {\n    __typename\n    ... on VisibleLotNumber {\n      __typename\n      lotNumber\n    }\n  }\n  slug\n  lotId\n  session {\n    __typename\n    stateV2 {\n      ...SessionStateCommonFragment\n      __typename\n    }\n  }\n  bidState {\n    ...TombstoneBidFlow_bidState\n    __typename\n  }\n  premiumLotState {\n    ...TombstoneBidFlow_PremiumLotState\n    __typename\n  }\n  withdrawnState {\n    ...TombstoneBidFlow_WithdrawnLotState\n    __typename\n  }\n  latestBid {\n    ...TombstoneBidFlow_UserBidConnection\n    __typename\n  }\n  ...TombstoneBidFlow_bidCapCheck\n}\n\nfragment TombstoneBidFlow_PremiumLotState on PremiumLotState {\n  __typename\n  id\n  isPremium\n  userIsWhitelisted\n}\n\nfragment TombstoneBidFlow_UserBidConnection on UserBidConnection {\n  __typename\n  id\n  bid {\n    __typename\n    lotId\n    bidState\n  }\n}\n\nfragment TombstoneBidFlow_WithdrawnLotState on LotWithdrawnState {\n  __typename\n  id\n  state\n}\n\nfragment TombstoneBidFlow_bidCapCheck on LotV2 {\n  __typename\n  auction {\n    __typename\n    enrollment {\n      __typename\n      bidCap {\n        ...TombstoneBidFlow_bidCap\n        __typename\n      }\n    }\n  }\n  bidState {\n    __typename\n    bidAsk\n  }\n  latestBid {\n    __typename\n    id\n    bid {\n      __typename\n      bidState\n      amountV2 {\n        __typename\n        amount\n      }\n    }\n  }\n}\n\nfragment TombstoneBidFlow_bidCap on BidCapConnection {\n  __typename\n  id\n  bidCap {\n    __typename\n    amount\n    amountInUse\n    isCapReached\n  }\n}\n\nfragment TombstoneBidFlow_bidState on BidState {\n  __typename\n  id\n  isClosed\n  bidTypeV2 {\n    __typename\n    ... on LiveBidType {\n      __typename\n      liveBidPhase\n    }\n    ... on TimedBidTypeV2 {\n      __typename\n      timedBidPhase\n    }\n  }\n}\n\nfragment TombstoneBidFlow_RegisterToBid on LotV2 {\n  __typename\n  sapAuctionSaleNumber\n  auction {\n    __typename\n    enrollment {\n      __typename\n      restrictedDate\n    }\n  }\n}\n\nfragment TombstoneBiddingInfo_BiddingInfo on LotV2 {\n  __typename\n  auction {\n    __typename\n    currencyV2\n  }\n  estimateV2 {\n    __typename\n    ... on LowHighEstimateV2 {\n      __typename\n      lowEstimate {\n        __typename\n        amount\n      }\n      highEstimate {\n        __typename\n        amount\n      }\n    }\n    ... on EstimateUponRequest {\n      __typename\n      estimateUponRequest\n    }\n  }\n  bidState {\n    ...TombstoneBiddingInfo_BidState\n    __typename\n  }\n  latestBid {\n    __typename\n    bid {\n      __typename\n      amountV2 {\n        __typename\n        amount\n      }\n      bidState\n      additionalLotsToBuy\n    }\n  }\n  lotTags\n  premiumLotState {\n    __typename\n    isPremium\n    userIsWhitelisted\n  }\n}\n\nfragment TombstoneBiddingInfo_BidState on BidState {\n  __typename\n  id\n  isClosed\n  bidTypeV2 {\n    __typename\n    ... on LiveBidType {\n      __typename\n      bidMethod\n      liveBidPhase\n    }\n    ... on TimedBidTypeV2 {\n      __typename\n      timedBidPhase\n    }\n  }\n  ...TombstoneBiddingInfo_timedBidState\n  ...TombstoneBiddingInfo_closedBidState\n  ...TombstoneBiddingInfo_liveBidState\n}\n\nfragment TombstoneBiddingInfo_closedBidState on BidState {\n  __typename\n  sold {\n    __typename\n    ... on ResultHidden {\n      __typename\n    }\n    ... on ResultVisible {\n      __typename\n      isSold\n      premiums {\n        __typename\n        finalPriceV2 {\n          __typename\n          amount\n        }\n      }\n    }\n  }\n}\n\nfragment TombstoneBiddingInfo_liveBidState on BidState {\n  __typename\n  currentBidV2 {\n    __typename\n    amount\n  }\n  startingBidV2 {\n    __typename\n    amount\n  }\n}\n\nfragment TombstoneBiddingInfo_timedBidState on BidState {\n  __typename\n  numberOfBids\n  reserveMet\n  startingBidV2 {\n    __typename\n    amount\n  }\n  currentBidV2 {\n    __typename\n    amount\n  }\n}\n\nfragment TombstoneEnterBidFragment on LotV2 {\n  __typename\n  auction {\n    __typename\n    currency\n    bidPhase {\n      __typename\n      auctionBidPhase {\n        __typename\n        ... on LiveAuctionBidPhaseType {\n          __typename\n          bidMethod\n        }\n      }\n    }\n    enrollment {\n      __typename\n      bidCap {\n        __typename\n        bidCap {\n          __typename\n          amount\n          amountInUse\n          isCapReached\n        }\n      }\n    }\n    bidIncrementTable {\n      __typename\n      id\n      bidIncrements {\n        __typename\n        from\n        increment\n      }\n      premiumIncrements {\n        __typename\n        from\n        percentage\n      }\n    }\n    locationV2 {\n      __typename\n      name\n    }\n    bidTypeAvailability {\n      __typename\n      advance {\n        __typename\n        availabilityStatus {\n          __typename\n          ... on DisabledAvailabilityStatus {\n            __typename\n            auctionId\n          }\n        }\n      }\n    }\n  }\n  parcel {\n    __typename\n    totalLotsInParcel\n    canSellAdditionalCount\n  }\n  bidState {\n    __typename\n    bidAsk\n    bidTypeV2 {\n      __typename\n      ... on TimedBidTypeV2 {\n        __typename\n      }\n      ... on LiveBidType {\n        __typename\n      }\n    }\n    startingBidV2 {\n      __typename\n      amount\n    }\n    currentBidV2 {\n      __typename\n      amount\n    }\n  }\n  estimateV2 {\n    __typename\n    ... on LowHighEstimateV2 {\n      __typename\n      lowEstimate {\n        __typename\n        amount\n      }\n    }\n  }\n  latestBid {\n    __typename\n    bid {\n      __typename\n      bidState\n      amountV2 {\n        __typename\n        amount\n      }\n    }\n  }\n}\n\nfragment TombstoneSelectAccountFragment on LotV2 {\n  __typename\n  auction {\n    __typename\n    location\n    conditionsOfSale\n  }\n}\n\nfragment UserBidInfoFragment on LotV2 {\n  __typename\n  auction {\n    __typename\n    currencyV2\n    enrollment {\n      __typename\n      bidCap {\n        __typename\n        bidCap {\n          __typename\n          isCapReached\n          amount\n          amountInUse\n        }\n      }\n    }\n  }\n  latestBid {\n    ...UserBidInfo_latestBid\n    __typename\n  }\n  bidState {\n    ...UserBidInfo_bidState\n    __typename\n  }\n  premiumLotState {\n    __typename\n    isPremium\n    userIsWhitelisted\n  }\n}\n\nfragment UserBidInfo_bidState on BidState {\n  __typename\n  id\n  bidAsk\n  sold {\n    __typename\n    ... on ResultHidden {\n      __typename\n    }\n    ... on ResultVisible {\n      __typename\n      isSold\n      premiums {\n        __typename\n        finalPriceV2 {\n          __typename\n          amount\n        }\n      }\n    }\n  }\n}\n\nfragment UserBidInfo_latestBid on UserBidConnection {\n  __typename\n  id\n  bid {\n    __typename\n    bidState\n    amountV2 {\n      __typename\n      amount\n    }\n  }\n}\n\nfragment RecommendedItemsFragment on LotV2 {\n  __typename\n  auction {\n    __typename\n    useCreatorSplit\n  }\n  recommendations(hideNonAvailable: true) {\n    __typename\n    ... on LotCard {\n      __typename\n      auction {\n        __typename\n        auctionId\n        currency\n      }\n      lotId\n      title\n      subtitle\n      lotNumber {\n        __typename\n        ... on VisibleLotNumber {\n          __typename\n          lotNumber\n        }\n      }\n      estimateV2 {\n        __typename\n        ... on EstimateUponRequest {\n          __typename\n          estimateUponRequest\n        }\n        ... on LowHighEstimateV2 {\n          __typename\n          highEstimate {\n            __typename\n            amount\n          }\n          lowEstimate {\n            __typename\n            amount\n          }\n        }\n      }\n      creators {\n        __typename\n        displayName\n      }\n      creatorPrefix\n      slug {\n        __typename\n        auctionSlug {\n          __typename\n          name\n          year\n        }\n        lotSlug\n      }\n      withdrawnState {\n        __typename\n        state\n      }\n      bidState {\n        __typename\n        isClosed\n      }\n    }\n    ... on RetailItem {\n      __typename\n      ...MarketplaceItemFragment\n    }\n  }\n}\n\nfragment MarketplaceItemFragment on RetailItem {\n  __typename\n  id\n  retailItemId\n  retailItemSlug: slug\n  title\n  propertyType\n  creators {\n    __typename\n    displayName\n  }\n  pricing {\n    __typename\n    listPrice\n    currency\n  }\n  media(imageSizes: [Small]) {\n    __typename\n    images {\n      __typename\n      renditions {\n        __typename\n        url\n        imageSize\n        width\n        height\n      }\n    }\n  }\n}\n\nfragment RecommendedWatchesFragment on LotV2 {\n  __typename\n  auction {\n    __typename\n    testRecord\n    currencyV2\n  }\n  lotId\n  title\n  estimateV2 {\n    __typename\n    ... on EstimateUponRequest {\n      __typename\n      estimateUponRequest\n    }\n    ... on LowHighEstimateV2 {\n      __typename\n      highEstimate {\n        __typename\n        amount\n      }\n      lowEstimate {\n        __typename\n        amount\n      }\n    }\n  }\n}\n\nfragment StickyHeaderContentFragment on LotV2 {\n  __typename\n  auction {\n    __typename\n    currencyV2\n    slug {\n      __typename\n      name\n      year\n    }\n    bidPhase {\n      ...AuctionBidPhaseFragment\n      __typename\n    }\n    auctionType: type\n  }\n  slug\n  lotId\n  title\n  bidState {\n    ...StickyHeaderContentBidStateFragment\n    __typename\n  }\n  ...StickyHeaderTitleFragment\n}\n\nfragment StickyHeaderContentBidStateFragment on BidState {\n  __typename\n  id\n  startingBid: startingBidV2 {\n    __typename\n    amount\n  }\n  currentBid: currentBidV2 {\n    __typename\n    amount\n  }\n  bidTypeV2 {\n    __typename\n    ... on LiveBidType {\n      __typename\n      bidMethod\n    }\n  }\n  isClosed\n  sold {\n    __typename\n    ... on ResultHidden {\n      __typename\n    }\n    ... on ResultVisible {\n      __typename\n      isSold\n      premiums {\n        __typename\n        finalPrice: finalPriceV2 {\n          __typename\n          amount\n        }\n      }\n    }\n  }\n}\n\nfragment StickyHeaderTitleFragment on LotV2 {\n  __typename\n  title\n  subtitle\n  lotNumber {\n    __typename\n    ... on VisibleLotNumber {\n      __typename\n      lotNumber\n    }\n    ... on HiddenLotNumber {\n      __typename\n      isHidden\n    }\n  }\n  auction {\n    __typename\n    useCreatorSplit\n  }\n  creatorPrefix\n  creators {\n    __typename\n    displayName\n  }\n}\n\nfragment UploadIdFragment on Auction {\n  __typename\n  sapSaleNumber\n  auctionLocation: locationV2 {\n    __typename\n    displayLocation {\n      __typename\n      name\n    }\n  }\n}\n"}
            yield scrapy.Request(url, method="POST", headers=headers, body=json.dumps(body), callback=self.parse_2, meta={'item': new_item})
        page = data['page']
        nbPages = data['nbPages']
        if page < nbPages:
            yield self.make_request(page + 1)

    def parse_2(self, response):
        item = response.meta['item']
        data = json.loads(response.body)
        item['price'] = data['data']['lot']['bidState']['sold']['premiums']['finalPrice']['amount']
        item['sold_date'] = data['data']['lot']['bidState']['closingTime']
        lotId=data['data']['lot']['lotId']
        item['thumbnail']=f'https://dam.sothebys.com/dam/image/lot/{lotId}/primary/small'
        images = data['data']['lot']['media']['images']
        images = [x['renditions'][0]['url'] for x in images]
        item['images'] = images
        description = data['data']['lot']['description']
        # remove html tags
        description = re.sub('<[^<]+?>', '', description)
        item['description'] = description
        yield item
